#!/bin/bash

# {{ ansible_managed }}

set -o xtrace

# Prepend executable if command starts with an option
if [ "${1:0:1}" = '-' ]; then
    set -- gitlab-runner "$@"
fi

# Allow the container to be stated with `--user`
if [ "$1" = 'gitlab-runner' ] && [ "$(id -u)" = '0' ]; then
    mkdir -p {{ gitlab_runner_runners_builds_dir }}
    chown gitlab-runner:gitlab-runner {{ gitlab_runner_runners_builds_dir }}
    chmod 0755 {{ gitlab_runner_runners_builds_dir }}

    mkdir -p {{ gitlab_runner_runners_cache_dir }}
    chown gitlab-runner:gitlab-runner {{ gitlab_runner_runners_cache_dir }}
    chmod 1777 {{ gitlab_runner_runners_cache_dir }}
fi

exec "$@"
